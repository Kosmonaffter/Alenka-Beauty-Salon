{% extends 'core/base.html' %}
{% load static %}

{% block title %}–§–æ—Ä–º–∞ –∑–∞–ø–∏—Å–∏ - –°–∞–ª–æ–Ω –∫—Ä–∞—Å–æ—Ç—ã{% endblock %}

{% block extra_css %}
<style>
    .time-slot {
        padding: 8px 12px;
        margin: 2px;
        border: 1px solid #dee2e6;
        border-radius: 4px;
        cursor: pointer;
        transition: all 0.2s;
        text-align: center;
        min-width: 60px;
    }
    .time-slot:hover {
        background-color: #e9ecef;
    }
    .time-slot.selected {
        background-color: #007bff;
        color: white;
        border-color: #007bff;
    }
    .time-slot.disabled {
        background-color: #f8f9fa;
        color: #6c757d;
        cursor: not-allowed;
        opacity: 0.6;
    }
    #time-slots-container {
        max-height: 200px;
        overflow-y: auto;
        border: 1px solid #dee2e6;
        border-radius: 4px;
        padding: 10px;
    }
    .time-slots-grid {
        display: grid;
        grid-template-columns: repeat(4, 1fr);
        gap: 5px;
    }
    @media (max-width: 768px) {
        .time-slots-grid {
            grid-template-columns: repeat(3, 1fr);
        }
    }
    @media (max-width: 576px) {
        .time-slots-grid {
            grid-template-columns: repeat(2, 1fr);
        }
    }
</style>
{% endblock %}

{% block content %}
<section class="hero-section">
    {% include 'core/includes/nav_buttons.html' %}
    
    <div class="container">
        <div class="row justify-content-center">
            <div class="col-lg-8">
                <img src="{% static 'images/Massage.ico' %}"
                     alt="–§–æ—Ä–º–∞ –∑–∞–ø–∏—Å–∏"
                     class="img-fluid rounded-circle mb-3"
                     width="80"
                     style="background: white; padding: 8px;">
                <h1 class="display-5 fw-bold mb-3">–§–æ—Ä–º–∞ –∑–∞–ø–∏—Å–∏</h1>
                <p class="lead mb-0">–ó–∞–ø–æ–ª–Ω–∏—Ç–µ —Ñ–æ—Ä–º—É –¥–ª—è –∑–∞–ø–∏—Å–∏ –Ω–∞ —É—Å–ª—É–≥—É</p>
            </div>
        </div>
    </div>
</section>

<section class="container my-5">
    <div class="row justify-content-center">
        <div class="col-md-8">
            <div class="card">
                <div class="card-header bg-primary text-white">
                    <h2 class="card-title mb-0">–ó–∞–ø–∏—Å—å –Ω–∞ —É—Å–ª—É–≥—É</h2>
                </div>
                <div class="card-body">
                    <form method="post" id="booking-form">
                        {% csrf_token %}
                        
                        {% if form.non_field_errors %}
                        <div class="alert alert-danger">
                            {% for error in form.non_field_errors %}
                                {{ error }}
                            {% endfor %}
                        </div>
                        {% endif %}

                        <div class="mb-3">
                            <label for="{{ form.procedure.id_for_label }}" class="form-label">–ü—Ä–æ—Ü–µ–¥—É—Ä–∞</label>
                            {{ form.procedure }}
                            {% if form.procedure.errors %}
                            <div class="text-danger">
                                {% for error in form.procedure.errors %}
                                    {{ error }}
                                {% endfor %}
                            </div>
                            {% endif %}
                        </div>

                        <div class="mb-3">
                            <label for="{{ form.master.id_for_label }}" class="form-label">–ú–∞—Å—Ç–µ—Ä</label>
                            {{ form.master }}
                            {% if form.master.errors %}
                            <div class="text-danger">
                                {% for error in form.master.errors %}
                                    {{ error }}
                                {% endfor %}
                            </div>
                            {% endif %}
                        </div>

                        <div class="row">
                            <div class="col-md-6 mb-3">
                                <label for="{{ form.booking_date.id_for_label }}" class="form-label">–î–∞—Ç–∞</label>
                                {{ form.booking_date }}
                                {% if form.booking_date.errors %}
                                <div class="text-danger">
                                    {% for error in form.booking_date.errors %}
                                        {{ error }}
                                    {% endfor %}
                                </div>
                                {% endif %}
                                <div class="form-text">–í—ã–±–µ—Ä–∏—Ç–µ –¥–∞—Ç—É –∏–∑ –∫–∞–ª–µ–Ω–¥–∞—Ä—è</div>
                            </div>
                            <div class="col-md-6 mb-3">
                                <label for="{{ form.booking_time.id_for_label }}" class="form-label">–í—Ä–µ–º—è</label>
                                <div id="time-slots-container">
                                    <div class="text-muted text-center py-3">
                                        –°–Ω–∞—á–∞–ª–∞ –≤—ã–±–µ—Ä–∏—Ç–µ –ø—Ä–æ—Ü–µ–¥—É—Ä—É, –º–∞—Å—Ç–µ—Ä–∞ –∏ –¥–∞—Ç—É
                                    </div>
                                </div>
                                <input type="hidden" name="booking_time" id="booking-time-input" required>
                                {% if form.booking_time.errors %}
                                <div class="text-danger">
                                    {% for error in form.booking_time.errors %}
                                        {{ error }}
                                    {% endfor %}
                                </div>
                                {% endif %}
                            </div>
                        </div>

                        <!-- –¢–æ–ª—å–∫–æ –ø–æ–ª–µ —Ç–µ–ª–µ—Ñ–æ–Ω–∞ –¥–ª—è –ø—Ä–æ–≤–µ—Ä–∫–∏ -->
                        <div class="mb-3">
                            <label for="{{ form.client_phone.id_for_label }}" class="form-label">
                                üìû –ù–æ–º–µ—Ä —Ç–µ–ª–µ—Ñ–æ–Ω–∞
                            </label>
                            {{ form.client_phone }}
                            {% if form.client_phone.errors %}
                            <div class="text-danger">
                                {% for error in form.client_phone.errors %}
                                    {{ error }}
                                {% endfor %}
                            </div>
                            {% endif %}
                            <div class="form-text">
                                –í–≤–µ–¥–∏—Ç–µ –≤–∞—à –Ω–æ–º–µ—Ä —Ç–µ–ª–µ—Ñ–æ–Ω–∞ –¥–ª—è –ø—Ä–æ–≤–µ—Ä–∫–∏
                            </div>
                        </div>

                        <div class="d-grid gap-2">
                            <button type="submit" class="btn btn-primary" id="submit-btn" disabled>
                                –ü—Ä–æ–¥–æ–ª–∂–∏—Ç—å
                            </button>
                            <a href="{% url 'booking:service_list' %}" class="btn btn-outline-secondary">
                                –ù–∞–∑–∞–¥ –∫ —É—Å–ª—É–≥–∞–º
                            </a>
                        </div>
                    </form>
                </div>
            </div>
        </div>
    </div>
</section>
{% endblock %}

{% block extra_js %}
<script>
document.addEventListener('DOMContentLoaded', function() {
    const serviceSelect = document.getElementById('id_procedure');
    const masterSelect = document.getElementById('id_master');
    const dateInput = document.getElementById('booking-date');
    const timeSlotsContainer = document.getElementById('time-slots-container');
    const bookingTimeInput = document.getElementById('booking-time-input');
    const submitBtn = document.getElementById('submit-btn');
    const phoneInput = document.getElementById('phone-input');
    let selectedTimeSlot = null;
    let isInitializing = false;

    // –§—É–Ω–∫—Ü–∏—è –¥–ª—è —Ñ–æ—Ä–º–∞—Ç–∏—Ä–æ–≤–∞–Ω–∏—è –Ω–æ–º–µ—Ä–∞ —Ç–µ–ª–µ—Ñ–æ–Ω–∞
    function formatPhoneNumber(input) {
        let value = input.value.replace(/\D/g, '');
        
        if (!value.startsWith('7') && !value.startsWith('+7') && value.length > 0) {
            if (value.startsWith('8')) {
                value = '7' + value.substring(1);
            } else if (value.length <= 10) {
                value = '7' + value;
            }
        }
        
        if (value.startsWith('7') && value.length === 11) {
            input.value = '+7 (' + value.substring(1, 4) + ') ' + value.substring(4, 7) + 
                         '-' + value.substring(7, 9) + '-' + value.substring(9, 11);
        }
    }

    // –û–±—Ä–∞–±–æ—Ç—á–∏–∫ —Ñ–æ—Ä–º–∞—Ç–∏—Ä–æ–≤–∞–Ω–∏—è —Ç–µ–ª–µ—Ñ–æ–Ω–∞
    if (phoneInput) {
        phoneInput.addEventListener('input', function(e) {
            formatPhoneNumber(e.target);
        });
        
        phoneInput.addEventListener('blur', function(e) {
            formatPhoneNumber(e.target);
        });
    }
    // –ü—Ä–æ–≤–µ—Ä–∫–∞ —Å—É—â–µ—Å—Ç–≤—É—é—â–µ–≥–æ –∫–ª–∏–µ–Ω—Ç–∞ –ø—Ä–∏ –∏–∑–º–µ–Ω–µ–Ω–∏–∏ —Ç–µ–ª–µ—Ñ–æ–Ω–∞
    if (phoneInput) {
        phoneInput.addEventListener('blur', function(e) {
            const phone = e.target.value.replace(/\D/g, '');
            if (phone.length >= 11) {
                // –ú–æ–∂–Ω–æ –¥–æ–±–∞–≤–∏—Ç—å AJAX –ø—Ä–æ–≤–µ—Ä–∫—É —Å—É—â–µ—Å—Ç–≤–æ–≤–∞–Ω–∏—è –∫–ª–∏–µ–Ω—Ç–∞
                // –∏ –ø–æ–∫–∞–∑–∞—Ç—å —Å–æ–æ–±—â–µ–Ω–∏–µ, —á—Ç–æ –∫–ª–∏–µ–Ω—Ç –Ω–∞–π–¥–µ–Ω
                console.log('–ü—Ä–æ–≤–µ—Ä–∫–∞ –∫–ª–∏–µ–Ω—Ç–∞ –ø–æ —Ç–µ–ª–µ—Ñ–æ–Ω—É:', phone);
            }
        });
        
        phoneInput.addEventListener('input', function(e) {
            formatPhoneNumber(e.target);
        });
    }
    function checkInitialValues() {
        if (isInitializing) return;
        isInitializing = true;

        const procedureId = serviceSelect.value;
        const masterId = masterSelect.value;
        const date = dateInput.value;

        if (procedureId && masterSelect.options.length <= 1) {
            loadMastersForProcedure(procedureId);
        }

        if (procedureId && masterId && date) {
            loadAvailableTimes();
        }

        setTimeout(() => { isInitializing = false; }, 100);
    }
    
    function loadMastersForProcedure(procedureId) {
        if (procedureId && !isInitializing) {
            fetch(`/booking/ajax/masters/?service_id=${procedureId}`)
                .then(response => response.json())
                .then(masters => {
                    masterSelect.innerHTML = '<option value="">–í—ã–±–µ—Ä–∏—Ç–µ –º–∞—Å—Ç–µ—Ä–∞</option>';
                    masters.forEach(master => {
                        const option = document.createElement('option');
                        option.value = master.id;
                        option.textContent = master.name;
                        masterSelect.appendChild(option);
                    });
                })
                .catch(error => console.error('Error loading masters:', error));
        }
    }

    if (serviceSelect) {
        serviceSelect.addEventListener('change', function() {
            const serviceId = this.value;
            if (serviceId) {
                loadMastersForProcedure(serviceId);
            } else {
                masterSelect.innerHTML = '<option value="">–í—ã–±–µ—Ä–∏—Ç–µ –º–∞—Å—Ç–µ—Ä–∞</option>';
                clearTimeSlots();
            }
        });
    }

    function loadAvailableTimes() {
        const masterId = masterSelect.value;
        const date = dateInput.value;
        const procedureId = serviceSelect.value;

        if (masterId && date && procedureId && !isInitializing) {
            timeSlotsContainer.innerHTML = `
                <div class="text-center py-3">
                    <div class="spinner-border text-primary" role="status"></div>
                    <div class="mt-2">–ó–∞–≥—Ä—É–∑–∫–∞ –¥–æ—Å—Ç—É–ø–Ω–æ–≥–æ –≤—Ä–µ–º–µ–Ω–∏...</div>
                </div>`;

            fetch(`/booking/ajax/times/?master_id=${masterId}&date=${date}&procedure_id=${procedureId}`)
                .then(response => response.json())
                .then(times => displayTimeSlots(times))
                .catch(error => {
                    console.error('Error loading times:', error);
                    timeSlotsContainer.innerHTML = '<div class="text-danger text-center py-3">–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ –≤—Ä–µ–º–µ–Ω–∏</div>';
                });
        } else {
            clearTimeSlots();
        }
    }

    if (masterSelect && dateInput) {
        masterSelect.addEventListener('change', loadAvailableTimes);
        dateInput.addEventListener('change', loadAvailableTimes);
        serviceSelect.addEventListener('change', loadAvailableTimes);
    }

    function displayTimeSlots(times) {
        if (times.length === 0) {
            timeSlotsContainer.innerHTML = '<div class="text-muted text-center py-3">–ù–µ—Ç –¥–æ—Å—Ç—É–ø–Ω–æ–≥–æ –≤—Ä–µ–º–µ–Ω–∏ –Ω–∞ –≤—ã–±—Ä–∞–Ω–Ω—É—é –¥–∞—Ç—É</div>';
            return;
        }

        let html = '<div class="time-slots-grid">';
        times.forEach(time => {
            html += `
                <div class="time-slot text-center" data-time="${time}">
                    ${time}
                </div>`;
        });
        html += '</div>';
        timeSlotsContainer.innerHTML = html;

        document.querySelectorAll('.time-slot').forEach(slot => {
            slot.addEventListener('click', function() {
                if (!this.classList.contains('disabled')) {
                    if (selectedTimeSlot) {
                        selectedTimeSlot.classList.remove('selected');
                    }
                    this.classList.add('selected');
                    selectedTimeSlot = this;
                    bookingTimeInput.value = this.getAttribute('data-time');
                    submitBtn.disabled = false;
                }
            });
        });
    }

    function clearTimeSlots() {
        timeSlotsContainer.innerHTML = '<div class="text-muted text-center py-3">–°–Ω–∞—á–∞–ª–∞ –≤—ã–±–µ—Ä–∏—Ç–µ –ø—Ä–æ—Ü–µ–¥—É—Ä—É, –º–∞—Å—Ç–µ—Ä–∞ –∏ –¥–∞—Ç—É</div>';
        bookingTimeInput.value = '';
        selectedTimeSlot = null;
        submitBtn.disabled = true;
    }

    document.getElementById('booking-form').addEventListener('submit', function(e) {
        if (!bookingTimeInput.value) {
            e.preventDefault();
            alert('–ü–æ–∂–∞–ª—É–π—Å—Ç–∞, –≤—ã–±–µ—Ä–∏—Ç–µ –≤—Ä–µ–º—è –¥–ª—è –∑–∞–ø–∏—Å–∏');
        }
    });

    setTimeout(checkInitialValues, 500);
});
</script>
{% endblock %}